<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>量化规则收集 Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <!-- 头部 -->
        <header class="header">
            <div class="header-content">
                <div>
                    <h1>🤖 量化规则收集 Agent</h1>
                    <p class="subtitle">通过对话完善你的量化交易策略</p>
                </div>
                <div class="user-controls">
                    <span id="userInfo" style="display: none; margin-right: 15px;"></span>
                    <button id="authBtn" class="btn btn-secondary" onclick="showAuthModal()">登录 / 注册</button>
                    <button id="myRulesBtn" class="btn btn-outline" style="display: none;" onclick="showMyRules()">我的策略</button>
                    <button id="logoutBtn" class="btn btn-outline" style="display: none;" onclick="logout()">退出</button>
                </div>
            </div>
        </header>

        <!-- 主要内容区 -->
        <div class="main-content">
            <!-- 聊天区域 -->
            <div class="chat-section">
                <div class="chat-header">
                    <h2>💬 对话区</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="modelSelector" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #e0e0e0; font-size: 14px;">
                            <option value="deepseek:deepseek-chat" selected>DeepSeek Chat</option>
                            <option value="deepseek:deepseek-coder">DeepSeek Coder</option>
                            <option value="openai:gpt-4o-mini">GPT-4o Mini</option>
                            <option value="openai:gpt-4o">GPT-4o</option>
                            <option value="openai:gpt-4-turbo">GPT-4 Turbo</option>
                        </select>
                        <button id="resetBtn" class="btn btn-secondary">重置会话</button>
                    </div>
                </div>
                
                <div id="chatMessages" class="chat-messages">
                    <div class="message bot-message">
                        <div class="message-content">
                            <div class="loading">初始化中...</div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <textarea 
                        id="userInput" 
                        class="chat-input" 
                        placeholder="在这里描述你的策略想法..."
                        rows="3"
                    ></textarea>
                    <button id="sendBtn" class="btn btn-primary">发送</button>
                </div>
            </div>

            <!-- 状态面板 -->
            <div class="state-section">
                <div class="state-header">
                    <h2>📋 规则状态</h2>
                    <div id="completenessIndicator" class="completeness-indicator incomplete">
                        未完成
                    </div>
                </div>
                
                <div id="stateContent" class="state-content">
                    <div class="state-loading">等待收集信息...</div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button id="saveRuleBtn" class="btn btn-primary" style="flex: 1;" disabled onclick="saveRule()">
                        💾 保存策略
                    </button>
                    <button id="finalizeBtn" class="btn btn-success" style="flex: 1;" disabled>
                        ⚡️ 生成最终规则
                    </button>
                </div>
            </div>
        </div>

        <!-- 指标参考 -->
        <div class="indicators-section collapsed">
            <div class="indicators-header" onclick="toggleIndicators()">
                <h3>📊 可用技术指标 <span class="toggle-icon">▼</span></h3>
            </div>
            <div id="indicatorsContent" class="indicators-content" style="display: none;">
                <div class="loading">加载中...</div>
            </div>
        </div>
    </div>

    <!-- 最终规则弹窗 -->
    <div id="finalRulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✅ 规则收集完成</h2>
                <span class="close" onclick="closeFinalRulesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p class="success-message">恭喜！你的量化策略已经完善。以下是最终的规则配置：</p>
                <pre id="finalRulesJson" class="json-display"></pre>
                <div class="modal-actions">
                    <button onclick="downloadRules()" class="btn btn-primary">下载配置</button>
                    <button onclick="copyRules()" class="btn btn-secondary">复制JSON</button>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- 登录/注册 模态框 -->
    <div id="authModal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close" onclick="closeAuthModal()">&times;</span>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthMode('login')">登录</button>
                <button class="auth-tab" onclick="switchAuthMode('register')">注册</button>
            </div>
            
            <!-- 登录表单 -->
            <div id="loginForm" class="auth-form">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="loginUsername" placeholder="请输入用户名">
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="loginPassword" placeholder="请输入密码">
                </div>
                <button class="btn btn-primary full-width" onclick="performLogin()">登录</button>
            </div>
            
            <!-- 注册表单 -->
            <div id="registerForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="regUsername" placeholder="设置用户名">
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="regPassword" placeholder="设置密码">
                </div>
                <button class="btn btn-success full-width" onclick="performRegister()">注册并自动登录</button>
            </div>
        </div>
    </div>

    <!-- 我的策略列表 模态框 -->
    <div id="myRulesModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>📚 我的策略库</h2>
                <span class="close" onclick="closeMyRulesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="rulesList" class="rules-list">
                    <div class="loading">加载中...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>

