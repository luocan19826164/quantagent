<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>量化规则收集 Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="app-wrapper">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <span class="logo-icon">📈</span>
                <span class="logo-text">QuantAgent</span>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" id="navRuleCollector" onclick="switchAgent('collector')">
                    <span class="nav-icon">🤖</span>
                    <span class="nav-text">规则收集</span>
                </a>
                <a href="#" class="nav-item" id="navRuleExecutor" onclick="switchAgent('executor')">
                    <span class="nav-icon">⚡</span>
                    <span class="nav-text">规则执行</span>
                </a>
                <a href="#" class="nav-item" id="navCodeAgent" onclick="switchAgent('code_agent')">
                    <span class="nav-icon">💻</span>
                    <span class="nav-text">量化代码</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div id="userInfoHeader" class="user-info-mini"></div>
            </div>
        </aside>

        <div class="container">
            <!-- 头部 -->
            <header class="header">
                <div class="header-content">
                    <div class="header-left">
                        <!-- 全屏模式下的返回按钮 -->
                        <button id="backToSidebarBtn" class="back-btn" onclick="exitFullscreenMode()" title="返回导航">
                            <span>☰</span>
                        </button>
                        <h1 id="headerTitle">🤖 量化规则收集 Agent</h1>
                    </div>
                    <div class="user-controls">
                        <div class="model-and-actions" id="headerModelActions">
                            <select id="modelSelector" class="model-selector header-select">
                                <option value="openrouter:anthropic/claude-sonnet-4" selected>Claude Sonnet 4</option>
                                <option value="openrouter:anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                                <option value="openrouter:anthropic/claude-3-opus">Claude 3 Opus</option>
                                <option value="openrouter:anthropic/claude-3-sonnet">Claude 3 Sonnet</option>
                                <option value="deepseek:deepseek-chat">DeepSeek Chat (V3)</option>
                                <option value="openai:gpt-4o">GPT-4o</option>
                                <option value="openai:gpt-4o-mini">GPT-4o-mini</option>
                            </select>
                        </div>
                        <span id="userInfo" style="display: none; margin-right: 15px;"></span>
                        <button id="authBtn" class="btn btn-secondary" onclick="showAuthModal()">登录 / 注册</button>
                        <button id="logoutBtn" class="btn btn-outline" style="display: none;"
                            onclick="logout()">退出</button>
                    </div>
                </div>
            </header>

            <!-- 主要内容区 (Collector View) -->
            <div class="main-content" id="collectorView">
                <div class="chat-section">
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input-area">
                        <div class="input-wrapper">
                            <textarea id="userInput" placeholder="描述你的策略，例如：'我想做一个均线金叉策略'..." rows="3"></textarea>
                            <button id="sendBtn" class="send-btn">
                                <span class="send-icon">↗️</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="state-section">
                    <div class="state-header">
                        <h3>📋 策略状态</h3>
                        <div id="completenessIndicator" class="completeness-indicator incomplete">⚠️ 未完成</div>
                    </div>
                    <div id="stateContent" class="state-content">
                        <div class="state-loading">等待收集信息...</div>
                    </div>
                    <div class="state-actions">
                        <button id="saveRuleBtn" class="btn btn-primary full-width" disabled onclick="saveRule()">✅
                            保存并开始执行</button>
                    </div>
                </div>
            </div>

            <!-- 执行Agent页面 (默认隐藏) -->
            <div id="executorView" class="main-content executor-view" style="display: none;">
                <!-- 策略列表（全宽） -->
                <div class="rules-execution-section full-width">
                    <div id="executionRulesList" class="execution-rules-grid">
                        <div class="loading">正在加载您的策略...</div>
                    </div>
                </div>
            </div>

            <!-- 代码 Agent 页面 (默认隐藏) -->
            <div id="codeAgentView" class="main-content code-agent-view" style="display: none;">
                <!-- 左侧：聊天区域 -->
                <div class="code-chat-section">
                    <div class="code-chat-header">
                        <h3>💬 对话</h3>
                    </div>
                    <div id="codeAgentMessages" class="code-chat-messages">
                        <div class="bot-message">你好！我是量化代码 Agent，可以帮你生成 Python 量化程序。请先选择或创建一个项目，然后描述你想要实现的功能。</div>
                    </div>
                    <div class="code-chat-input-area">
                        <textarea id="codeAgentInput" placeholder="描述你想要的功能..." rows="3"></textarea>
                        <button id="codeAgentSendBtn" class="send-btn">
                            <span class="send-icon">↗️</span>
                        </button>
                    </div>
                </div>

                <!-- 中间：只显示代码内容 -->
                <div class="code-panel-section" id="codePanelSection">
                    <div class="file-editor-container">
                        <div class="file-editor-header">
                            <span id="currentFileName">未选择文件</span>
                            <div class="file-editor-actions">
                                <button class="btn btn-sm" id="editFileBtn">✏️ 编辑</button>
                                <button class="btn btn-sm btn-primary" id="saveFileBtn" style="display: none;">💾 保存</button>
                                <button class="btn btn-sm" id="cancelEditBtn" style="display: none;">取消</button>
                            </div>
                        </div>
                        <div class="file-editor-content">
                            <pre id="codeDisplayWrapper"><code id="codeDisplay" class="code-display language-python"></code></pre>
                            <textarea id="codeTextarea" class="file-editor-textarea" style="display: none;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 右侧：文件列表 + 终端 -->
                <div class="file-browser-section">
                    <!-- 项目选择器 -->
                    <div class="project-selector">
                        <select id="projectSelector">
                            <option value="">选择项目...</option>
                        </select>
                        <button class="btn btn-sm btn-primary" id="createProjectBtn">+</button>
                        <button class="btn btn-sm btn-danger" id="deleteProjectBtn" title="删除">🗑</button>
                    </div>
                    
                    <!-- 文件树 -->
                    <div class="file-tree-container">
                        <div class="file-tree-header">
                            <h4>📁 文件</h4>
                            <button class="btn btn-sm" onclick="loadCodeAgentFiles()" title="刷新">🔄</button>
                        </div>
                        <div id="fileTree" class="file-tree">
                            <div class="file-tree-placeholder">请选择项目</div>
                        </div>
                    </div>
                    
                    <!-- 终端 -->
                    <div class="execution-output-container">
                        <div class="execution-output-header">
                            <span>📤 终端</span>
                            <div class="execution-controls">
                                <select id="executionTimeout" class="timeout-selector">
                                    <option value="60">1分钟</option>
                                    <option value="300" selected>5分钟</option>
                                    <option value="1800">30分钟</option>
                                </select>
                                <button class="btn btn-sm btn-success" id="runCodeBtn" title="运行">▶</button>
                                <button class="btn btn-sm btn-danger" id="stopCodeBtn" disabled title="停止">⏹</button>
                            </div>
                        </div>
                        <div class="command-input-wrapper">
                            <span class="command-prompt">$</span>
                            <input type="text" id="commandInput" class="command-input" placeholder="输入命令..." />
                            <span id="commandSpinner" class="command-spinner" style="display: none;">⏳</span>
                        </div>
                        <div id="executionStatus" class="execution-status" style="display: none;"></div>
                        <div id="executionOutput" class="execution-output">
                            <div class="output-placeholder">输出显示在这里...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 规则详情页面 (默认隐藏) -->
            <div id="ruleDetailView" class="main-content rule-detail-view" style="display: none;">
                <div class="rule-detail-container">
                    <!-- 返回按钮 -->
                    <div class="detail-header">
                        <button class="btn btn-outline back-btn" onclick="backToExecutor()">
                            ← 返回列表
                        </button>
                        <h2 id="ruleDetailTitle">📋 规则详情</h2>
                    </div>
                    
                    <!-- 规则信息卡片 -->
                    <div class="rule-info-section">
                        <div class="section-header">
                            <h3>📊 规则配置</h3>
                            <span id="ruleStatusBadge" class="exec-status-badge"></span>
                        </div>
                        <div id="ruleInfoContent" class="rule-info-grid">
                            <div class="loading">加载中...</div>
                        </div>
                    </div>
                    
                    <!-- 历史订单表格 -->
                    <div class="rule-orders-section">
                        <div class="section-header">
                            <h3>📝 相关订单历史</h3>
                        </div>
                        <div class="orders-table-container">
                            <table class="orders-table">
                                <thead>
                                    <tr>
                                        <th>订单ID</th>
                                        <th>时间</th>
                                        <th>交易对</th>
                                        <th>方向</th>
                                        <th>价格</th>
                                        <th>数量</th>
                                        <th>状态</th>
                                        <th>盈亏</th>
                                    </tr>
                                </thead>
                                <tbody id="ruleOrdersTableBody">
                                    <tr>
                                        <td colspan="8" class="no-data">暂无订单数据</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- container end -->
    </div> <!-- app-wrapper end -->

    <!-- 最终规则弹窗 -->
    <div id="finalRulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✅ 规则收集完成</h2>
                <span class="close" onclick="closeFinalRulesModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p class="success-message">恭喜！你的量化策略已经完善。以下是最终的规则配置：</p>
                <pre id="finalRulesJson" class="json-display"></pre>
                <div class="modal-actions">
                    <button onclick="downloadRules()" class="btn btn-primary">下载配置</button>
                    <button onclick="copyRules()" class="btn btn-secondary">复制JSON</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录/注册 模态框 -->
    <div id="authModal" class="modal">
        <div class="modal-content auth-modal-content">
            <span class="close" onclick="closeAuthModal()">&times;</span>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthMode('login')">登录</button>
                <button class="auth-tab" onclick="switchAuthMode('register')">注册</button>
            </div>

            <!-- 登录表单 -->
            <div id="loginForm" class="auth-form">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="loginUsername" placeholder="请输入用户名">
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="loginPassword" placeholder="请输入密码">
                </div>
                <button class="btn btn-primary full-width" onclick="performLogin()">登录</button>
            </div>

            <!-- 注册表单 -->
            <div id="registerForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="regUsername" placeholder="设置用户名">
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="regPassword" placeholder="设置密码">
                </div>
                <button class="btn btn-success full-width" onclick="performRegister()">注册并自动登录</button>
            </div>
        </div>
    </div>

    <!-- 创建项目模态框 -->
    <div id="createProjectModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>📁 创建新项目</h2>
                <span class="close" onclick="closeCreateProjectModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>项目名称</label>
                    <input type="text" id="newProjectName" placeholder="我的量化策略">
                </div>
                <div class="form-group">
                    <label>项目描述（可选）</label>
                    <textarea id="newProjectDesc" placeholder="描述你的项目..." rows="2"></textarea>
                </div>
                <button class="btn btn-primary full-width" onclick="createProject()">创建项目</button>
            </div>
        </div>
    </div>

    <!-- Prism.js 代码高亮 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>