# QuantAgent - 产品与技术设计文档

> 版本：1.0  
> 更新日期：2026-01-17

---

## 📋 目录

1. [产品概述](#产品概述)
2. [核心功能](#核心功能)
3. [系统架构](#系统架构)
4. [技术实现](#技术实现)
5. [数据模型](#数据模型)
6. [API 设计](#api-设计)
7. [Agent 设计](#agent-设计)
8. [部署方案](#部署方案)

---

## 产品概述

### 🎯 产品定位

QuantAgent 是一个 **AI 驱动的量化交易策略管理平台**，通过智能对话帮助用户设计、完善并自动执行量化交易策略。

### 🌟 核心价值

| 痛点 | 解决方案 |
|------|----------|
| 量化策略配置复杂，需要专业知识 | AI 对话引导，逐步完善策略细节 |
| 手动编写策略代码门槛高 | 自然语言描述 → 自动生成执行计划 |
| 策略执行需要 7x24 盯盘 | 云端自动执行，按设定周期运行 |
| 多交易所 API 对接繁琐 | 统一抽象层，支持多交易所扩展 |

### 👥 目标用户

- **量化入门者**：想尝试量化交易，但不会写代码
- **交易员**：有策略想法，希望快速验证和自动化执行
- **量化开发者**：需要一个快速原型验证平台

---

## 核心功能

### 功能全景图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         QuantAgent 平台                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   ┌─────────────────┐      ┌─────────────────┐      ┌────────────┐ │
│   │  规则收集 Agent  │  →   │    策略存储     │  →   │  执行Agent │ │
│   │   (对话引导)     │      │   (SQLite)      │      │  (ReAct)   │ │
│   └─────────────────┘      └─────────────────┘      └────────────┘ │
│           ↑                                                ↓        │
│   ┌───────────────────────────────────────────────────────────────┐ │
│   │                        Web UI 界面                            │ │
│   │   • 智能对话窗口   • 策略状态面板   • 执行监控   • 订单历史   │ │
│   └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 功能模块详解

#### 1️⃣ 规则收集 Agent

**功能描述**：通过多轮智能对话，引导用户完善量化交易策略的所有必要参数。

**收集的策略要素**：

| 要素 | 说明 | 示例 |
|------|------|------|
| 交易所 (exchange) | 支持的交易所 | Binance, OKX, Bybit |
| 产品类型 (product) | 现货/合约 | spot, contract |
| 交易对 (symbols) | 交易币种列表 | BTCUSDT, ETHUSDT |
| K线周期 (timeframe) | 分析周期 | 1m, 5m, 1h, 1d |
| 建仓规则 (entry_rules) | 开仓条件 | RSI<30 且 MACD金叉 |
| 止盈规则 (take_profit) | 止盈条件 | 3% |
| 止损规则 (stop_loss) | 止损条件 | 2% |
| 总本金 (total_capital) | 可用资金 | 10000 USDT |
| 仓位比例 (max_position_ratio) | 单笔仓位占比 | 0.2 (20%) |

**交互流程**：

```
用户: "我想做一个RSI超卖策略"
  ↓
Agent: "好的，RSI超卖策略。请问您希望RSI值低于多少时触发买入？
        常见阈值有：RSI<20（极度超卖）、RSI<30（超卖）"
  ↓
用户: "RSI低于30时买入"
  ↓
Agent: "明白，RSI<30时买入。您想在哪个交易所交易？
        目前支持：Binance、OKX、Bybit"
  ↓
... (继续收集其他要素)
  ↓
Agent: "策略已完整！以下是执行计划：
        1. 获取K线数据
        2. 计算RSI指标
        3. 判断建仓/止盈止损条件
        4. 执行交易"
```

#### 2️⃣ 策略执行 Agent

**功能描述**：基于 ReAct (Reasoning + Acting) 模式，自动执行已保存的交易策略。

**执行模式**：

```
┌──────────────────────────────────────────────────────────────┐
│                    ReAct 执行循环                            │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│   Step 1: 🔍 获取数据                                        │
│   {"type": "tool_call", "action": {"tool_name": "get_kline_data"}} │
│                           ↓                                   │
│   Step 2: 📊 计算指标                                        │
│   {"type": "calculation", "action": {"calculation_type": "RSI"}}   │
│                           ↓                                   │
│   Step 3: 🎯 做出决策                                        │
│   {"type": "decision", "action": {"action": "buy/sell/hold"}}      │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

**支持的交易类型**：

| 产品类型 | 支持操作 | 说明 |
|---------|---------|------|
| 现货 (spot) | buy/sell | 买入开仓、卖出平仓 |
| 合约 (contract) | buy(开多)/sell(开空)/平仓 | 支持双向交易 |

**定时执行**：

- 使用 APScheduler 实现
- 根据策略的 K线周期自动调度（如 1h 策略每小时执行一次）
- 服务重启后自动恢复运行中的策略

#### 3️⃣ 用户系统

- **注册/登录**：用户名 + 密码认证
- **会话管理**：7天有效期的 Session
- **数据隔离**：用户只能访问自己的策略和订单

#### 4️⃣ 策略管理

- **保存策略**：将完善的策略持久化到数据库
- **策略列表**：查看所有已保存的策略
- **启动/停止**：控制策略的执行状态
- **策略详情**：查看策略配置和关联订单

#### 5️⃣ 订单追踪

- **订单记录**：每笔交易自动记录
- **盈亏计算**：实时更新浮动盈亏
- **历史查询**：按规则查看订单历史

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              客户端层                                    │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                      Web Browser (SPA)                            │  │
│  │    index.html + style.css + script.js                             │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP / WebSocket (未来)
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                              服务层                                      │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                     Flask Application (app.py)                    │  │
│  │    • REST API 路由                                                │  │
│  │    • Session 管理                                                 │  │
│  │    • 请求验证                                                     │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                         │                    │                          │
│                         ↓                    ↓                          │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────┐  │
│  │   Rule Collector Agent      │  │     Execution Agent             │  │
│  │   • 多轮对话管理            │  │     • ReAct 执行循环            │  │
│  │   • 状态更新与验证          │  │     • 定时调度 (APScheduler)    │  │
│  │   • 执行计划生成            │  │     • 持仓状态管理              │  │
│  └─────────────────────────────┘  └─────────────────────────────────┘  │
│                         │                    │                          │
│                         └─────────┬──────────┘                          │
│                                   ↓                                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                        LangChain + LLM                            │  │
│  │    • ChatOpenAI (GPT-4 / DeepSeek)                                │  │
│  │    • Prompt Template                                              │  │
│  │    • Conversation Memory                                          │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                              数据层                                      │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────┐  │
│  │      SQLite Database        │  │      External APIs              │  │
│  │    • users (用户表)         │  │    • Binance API                │  │
│  │    • saved_rules (规则表)   │  │    • (可扩展其他交易所)         │  │
│  │    • orders (订单表)        │  │                                  │  │
│  └─────────────────────────────┘  └─────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 目录结构

```
quantagent/
├── backend/
│   ├── __init__.py
│   ├── app.py                    # Flask 主应用入口
│   ├── database.py               # 数据库操作封装
│   ├── agent/
│   │   ├── __init__.py
│   │   ├── rule_collect_agent.py # 规则收集 Agent
│   │   ├── execution_agent.py    # 执行 Agent
│   │   ├── state_manager.py      # 状态管理器
│   │   ├── prompt_loader.py      # Prompt 加载器
│   │   └── prompts/
│   │       ├── rule_collect_agent_prompt.yaml
│   │       └── execution_agent_prompt.yaml
│   └── tool/
│       ├── __init__.py
│       ├── tools_catalog.py      # 工具定义（@tool 注解）
│       ├── capability_manifest.py # 能力清单生成器
│       └── binance/
│           ├── __init__.py
│           └── client.py         # Binance API 客户端
├── frontend/
│   ├── templates/
│   │   └── index.html            # 主页面
│   └── static/
│       ├── style.css             # 样式
│       └── script.js             # 前端逻辑
├── requirements.txt
├── .env                          # 环境变量配置
└── quant.db                      # SQLite 数据库文件
```

---

## 技术实现

### 技术栈

| 层级 | 技术选型 | 版本 |
|------|---------|------|
| 后端框架 | Flask | 2.x |
| AI 框架 | LangChain | 0.1.x |
| LLM | OpenAI GPT-4 / DeepSeek | - |
| 数据库 | SQLite | 3.x |
| 定时任务 | APScheduler | 3.x |
| 前端 | 原生 HTML/CSS/JS | - |
| 交易所 SDK | python-binance | - |

### 核心设计模式

#### 1. Prompt 与代码分离

**设计理念**：将 Prompt 配置从代码中抽离，使用 YAML 文件管理，便于调优和维护。

```yaml
# prompts/rule_collect_agent_prompt.yaml
system_prompt_template: |
  你是一个专业的量化交易策略顾问...
  
  【能力清单】
  {capability_text}
  
  【输出格式】
  {output_schema}
```

```python
# prompt_loader.py
class PromptLoader:
    def __init__(self, config_path: str):
        with open(config_path, 'r') as f:
            self.config = yaml.safe_load(f)
    
    def build_system_prompt(self, **kwargs) -> str:
        template = self.config['system_prompt_template']
        return template.format(**kwargs)
```

#### 2. 单一事实源 (SSOT) - 能力清单

**设计理念**：工具的定义（`@tool` 注解）是唯一的事实源，能力清单自动从工具函数提取，避免手动同步。

```python
# tools_catalog.py - 定义工具
@tool
def get_kline_data(exchange: str, symbol: str, timeframe: str, limit: int = 100) -> List[Dict]:
    """
    获取K线数据。
    
    参数：
      - exchange: 交易所名称
      - symbol: 交易对
      - timeframe: 时间周期
      - limit: 获取数量
    
    返回：K线数据列表
    """
    # 实现...
```

```python
# capability_manifest.py - 自动提取
def get_capability_manifest_text() -> str:
    """从 @tool 函数自动提取能力清单"""
    parts = []
    for tool in tc.ALL_TOOLS:
        meta = _extract_tool_metadata(tool)  # 从函数签名和 docstring 提取
        parts.append(f"• {meta['name']}({meta['param_names']})")
        parts.append(f"  {meta['description']}")
    return "\n".join(parts)
```

#### 3. ReAct 执行模式

**设计理念**：执行 Agent 使用 ReAct (Reasoning + Acting) 模式，每一步都有明确的推理过程。

```
ReAct Loop:
┌──────────────────────────────────────────────────────────────┐
│  while step < max_steps:                                     │
│      1. 构建 Prompt（包含历史执行记录）                       │
│      2. 调用 LLM 获取下一步操作                              │
│      3. 解析 JSON 响应                                        │
│      4. if type == "tool_call":                              │
│             执行工具 → 记录结果到 memory                      │
│         elif type == "calculation":                          │
│             记录中间计算结果到 memory                         │
│         elif type == "decision":                             │
│             返回最终决策 (buy/sell/hold)                      │
│      5. step++                                                │
└──────────────────────────────────────────────────────────────┘
```

#### 4. 状态管理

**设计理念**：每个交易对独立维护持仓状态，支持多币种并行执行。

```python
# 状态结构
runtime_status = {
    "BTCUSDT": {
        "is_holding": True,
        "entry_price": 42000.0,
        "quantity": 0.5,
        "position_side": "long",  # 合约用
        "db_order_id": 123,
        "last_update": "2026-01-17T10:30:00"
    },
    "ETHUSDT": {
        "is_holding": False,
        ...
    }
}
```

---

## 数据模型

### ER 图

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│     users       │       │   saved_rules   │       │     orders      │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │──1:N─→│ id (PK)         │──1:N─→│ id (PK)         │
│ username        │       │ user_id (FK)    │       │ rule_id (FK)    │
│ password_hash   │       │ name            │       │ symbol          │
│ created_at      │       │ rule_content    │       │ side            │
└─────────────────┘       │ total_capital   │       │ amount          │
                          │ status          │       │ price           │
                          │ created_at      │       │ status          │
                          └─────────────────┘       │ pnl             │
                                                    │ order_id        │
                                                    │ created_at      │
                                                    └─────────────────┘
```

### 表结构详解

#### users 表

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### saved_rules 表

```sql
CREATE TABLE saved_rules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT,                              -- 策略名称
    user_id INTEGER NOT NULL,               -- 关联用户
    rule_content TEXT NOT NULL,             -- JSON 格式的策略内容
    total_capital FLOAT,                    -- 总本金
    status TEXT DEFAULT 'stopped',          -- running/stopped
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id)
);
```

**rule_content JSON 结构**：

```json
{
  "user_requirements": {
    "exchange": "Binance",
    "product": "spot",
    "symbols": ["BTCUSDT", "ETHUSDT"],
    "timeframe": "1h",
    "entry_rules": "RSI低于30且MACD金叉时买入",
    "take_profit": "3%",
    "stop_loss": "2%",
    "total_capital": 10000,
    "max_position_ratio": 0.2,
    "execute_plan": "...(伪代码执行计划)"
  },
  "runtime_status": {
    "BTCUSDT": {
      "is_holding": false,
      "entry_price": null,
      "quantity": 0,
      "position_side": null,
      "db_order_id": null
    }
  }
}
```

#### orders 表

```sql
CREATE TABLE orders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    rule_id INTEGER NOT NULL,               -- 关联策略
    symbol TEXT NOT NULL,                   -- 交易对
    side TEXT NOT NULL,                     -- buy/sell
    amount FLOAT NOT NULL,                  -- 交易数量
    price FLOAT NOT NULL,                   -- 成交价格
    status TEXT NOT NULL,                   -- open/closed
    pnl FLOAT DEFAULT 0.0,                  -- 盈亏百分比
    order_id TEXT,                          -- 交易所订单ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (rule_id) REFERENCES saved_rules (id)
);
```

---

## API 设计

### API 列表

| 分类 | 方法 | 路径 | 说明 |
|------|------|------|------|
| **会话** | POST | `/api/init` | 初始化对话会话 |
| | POST | `/api/chat` | 发送对话消息 |
| | GET | `/api/state/<session_id>` | 获取当前策略状态 |
| | POST | `/api/reset/<session_id>` | 重置会话 |
| **认证** | POST | `/api/register` | 用户注册 |
| | POST | `/api/login` | 用户登录 |
| | GET | `/api/check_status` | 检查登录状态 |
| | POST | `/api/logout` | 退出登录 |
| **策略** | POST | `/api/save_rule` | 保存策略 |
| | GET | `/api/my_rules` | 获取我的策略列表 |
| | GET | `/api/rules/<id>/detail` | 获取策略详情 |
| | POST | `/api/rules/<id>/toggle` | 启动/停止策略 |
| **订单** | GET | `/api/orders` | 获取订单历史 |
| **配置** | GET | `/api/indicators` | 获取支持的指标 |
| | GET | `/api/markets` | 获取市场配置 |
| | GET | `/api/models` | 获取可用模型 |
| | POST | `/api/switch-model/<session_id>` | 切换模型 |

### 核心 API 详解

#### POST /api/chat

**请求**：
```json
{
  "session_id": "uuid-xxx",
  "message": "我想做一个RSI超卖策略"
}
```

**响应**：
```json
{
  "success": true,
  "response": "好的，RSI超卖策略。请问您希望RSI值低于多少时触发买入？",
  "state": {
    "user_requirements": {
      "exchange": null,
      "product": null,
      "symbols": [],
      "entry_rules": null,
      ...
    }
  },
  "is_complete": false,
  "missing_fields": ["交易所名称", "交易对", "K线周期", ...]
}
```

#### POST /api/rules/<id>/toggle

**请求**：
```json
{
  "active": true
}
```

**响应**：
```json
{
  "success": true
}
```

---

## Agent 设计

### Rule Collector Agent

**职责**：通过多轮对话收集用户的量化策略需求。

**核心流程**：

```
┌────────────────────────────────────────────────────────────────┐
│                   Rule Collector Agent                          │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 接收用户输入                                                │
│     └─→ user_input: "我想在Binance做BTC现货交易"              │
│                                                                 │
│  2. 构建 Prompt                                                │
│     └─→ System Prompt (from YAML) + 能力清单 + 历史对话       │
│                                                                 │
│  3. 调用 LLM (JSON Mode)                                       │
│     └─→ 返回: {"reply": "...", "state_update": {...}}         │
│                                                                 │
│  4. 解析并验证 state_update                                    │
│     └─→ 验证交易所、产品、交易对的有效性                       │
│                                                                 │
│  5. 更新状态                                                   │
│     └─→ 增量更新 QuantRuleState                                │
│                                                                 │
│  6. 检查完整性                                                 │
│     └─→ 如果完整且 finish=true，激活保存按钮                  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

**LLM 输出格式**：

```json
{
  "reply": "给用户的自然语言回复",
  "state_update": {
    "exchange": "Binance",
    "product": "spot",
    "symbols": ["BTCUSDT"],
    "timeframe": null,
    ...
  }
}
```

### Execution Agent

**职责**：执行已保存的交易策略，做出交易决策。

**核心流程**：

```
┌────────────────────────────────────────────────────────────────┐
│                    Execution Agent (ReAct)                      │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  定时触发（根据 timeframe）                                    │
│      ↓                                                          │
│  for symbol in symbols:                                         │
│      │                                                          │
│      ├─→ 1. 获取该 symbol 的持仓状态                           │
│      │                                                          │
│      ├─→ 2. 如有持仓，更新浮动盈亏                             │
│      │                                                          │
│      ├─→ 3. ReAct 循环 (最多 20 步)                            │
│      │       │                                                  │
│      │       ├─ tool_call: 获取 K线数据                        │
│      │       ├─ calculation: 计算技术指标                       │
│      │       └─ decision: 返回 buy/sell/hold                   │
│      │                                                          │
│      └─→ 4. 执行交易（如有决策）                               │
│              │                                                  │
│              ├─ spot: buy(开仓) / sell(平仓)                   │
│              └─ contract: buy(开多/平空) / sell(开空/平多)     │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

**LLM 输出格式**：

```json
// 工具调用
{"type": "tool_call", "reasoning": "...", "action": {"tool_name": "get_kline_data", "params": {...}}}

// 计算
{"type": "calculation", "reasoning": "...", "action": {"calculation_type": "RSI", "intermediate_result": {"rsi": 28.5}}}

// 决策
{"type": "decision", "reasoning": "...", "action": {"action": "buy", "reason": "RSI<30触发买入", "confidence": 0.85}}
```

---

## 部署方案

### 开发环境

```bash
# 1. 克隆代码
git clone <repo_url>
cd quantagent

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate  # Windows

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 填入 API Key

# 5. 启动服务
python backend/app.py
```

### 环境变量

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `OPENAI_API_KEY` | OpenAI API 密钥 | sk-xxx |
| `OPENAI_BASE_URL` | OpenAI API 地址 | https://api.openai.com/v1 |
| `DEEPSEEK_API_KEY` | DeepSeek API 密钥 | sk-xxx |
| `MODEL_NAME` | 默认使用的模型 | gpt-4o |
| `SECRET_KEY` | Flask Session 密钥 | random-string |
| `FLASK_DEBUG` | 调试模式 | 0 或 1 |
| `BINANCE_API_KEY` | Binance API Key | xxx |
| `BINANCE_SECRET_KEY` | Binance Secret | xxx |

### 生产部署建议

```
┌─────────────────────────────────────────────────────────────────┐
│                      生产环境架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────────┐  │
│   │   Nginx     │ →   │   Gunicorn  │ →   │  Flask App      │  │
│   │  (反向代理)  │     │  (WSGI)     │     │  (多进程)       │  │
│   └─────────────┘     └─────────────┘     └─────────────────┘  │
│                                                    │             │
│                                                    ↓             │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                 PostgreSQL / MySQL                       │   │
│   │                 (替代 SQLite)                            │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**建议**：

1. **数据库**：生产环境使用 PostgreSQL 或 MySQL 替代 SQLite
2. **进程管理**：使用 Gunicorn + Supervisor
3. **反向代理**：使用 Nginx 处理静态文件和 SSL
4. **日志**：接入 ELK 或云日志服务
5. **监控**：接入 Prometheus + Grafana
6. **API 限流**：使用 Flask-Limiter 或 Nginx 限流

---

## 附录

### 支持的技术指标

| 指标 | 说明 | 状态 |
|------|------|------|
| MA | 简单移动平均线 | ✅ 支持 |
| EMA | 指数移动平均线 | ✅ 支持 |
| RSI | 相对强弱指标 | ✅ 支持 |
| MACD | 指数平滑异同移动平均线 | ✅ 支持 |
| BOLL | 布林带 | ✅ 支持 |
| KDJ | 随机指标 | ❌ 暂不支持 |
| ATR | 平均真实波幅 | ❌ 暂不支持 |

### 支持的交易所

| 交易所 | 现货 | 合约 | 状态 |
|--------|------|------|------|
| Binance | ✅ | ✅ | 已接入 |
| OKX | ✅ | ✅ | 规划中 |
| Bybit | ✅ | ✅ | 规划中 |

---

> **文档维护**：本文档随代码同步更新，如有疑问请联系开发团队。

