# Code Agent 设计审计总结

> 目标：评估当前 `backend/agent/code_agent` 的实现是否符合主流编程 Agent（如 Cursor 类产品）的设计机制，并找出生产化风险与缺口。
> 说明：不修改代码，仅审计结论与建议。

---

## 1. 结论概览

- **Plan 机制是必要的**：主流编程 Agent 均具备“计划—执行—追踪”的能力，只是可能以不同形态内置在 orchestrator 中。
- 当前实现的 **方向正确但强度不足**：计划追踪更多是“提示层”，无法形成强约束，生产环境下难以保证可控性与审计性。
- **最大风险是架构双轨**：`CodeAgent` 与 `PlanExecuteAgent` 并存且行为不一致，导致审批、追踪、版本与工具安全策略被绕过。

---

## 2. 核心风险与缺陷（按严重度）

### 高风险

1. **双 Agent 体系导致不可控与不一致**
   - `CodeAgent` 直接解析 LLM 输出并写文件，绕过计划审批与步骤追踪。
   - 计划审批对部分入口失效，导致执行不可控。

2. **计划追踪不能约束工具执行**
   - `PlanTracker` 仅通过“响应文本”检测跳步/偏离，而不是在工具执行层强制限制。
   - LLM 即使不在回复中表述，也可调用任意工具修改文件。

3. **Shell 在宿主机执行，不在沙箱**
   - `ShellExecTool` 使用宿主机 `subprocess.run`。
   - 与 Docker sandbox 分离，存在明显安全风险与逃逸风险。

---

### 中风险

4. **RAG 没有接入执行链**
   - 实际上下文检索仍是“最多读 3 个文件”，未使用语义检索/AST 结构检索。

5. **计划与执行状态不可持久化**
   - plan/tracker 完全内存化，服务重启或中断后无法恢复执行与审计状态。

6. **审批机制非强约束**
   - 实际行为仍由 LLM 控制，审批不强制执行范围与工具权限。

---

### 低风险 / 优化项

7. **Plan JSON 解析鲁棒性不足**
   - LLM 返回不规范时 fallback 成单步计划，易误通过。

8. **跳步检测策略过于脆弱**
   - 依赖关键词匹配，中文/英文及同义替换容易绕过。

9. **修改机制仍以全量文件为主**
   - `CodeAgent` 依赖 LLM 回传完整文件块，未形成“高效 patch/增量修改”闭环。

---

## 3. 关于“Plan 目录是否必要 / Cursor 是否有类似机制”

- **必要性**：编程 Agent 必须具备“计划-执行-追踪”的控制闭环，否则无法保证目标对齐与安全性。
- **主流实践**：Cursor/Claude/Copilot 类产品均采用某种 Plan-Execute/Act-Reflect 机制，只是可能隐藏在内部 orchestration 层，不一定以 `plan/` 目录呈现。
- **结论**：你的 `plan` 目录不是多余，反而是关键模块，但需要强化为“控制层”，而不仅是“提示层”。

---

## 4. 与主流编程 Agent 的差距清单

| 领域 | 当前状态 | 生产级期望 |
|------|----------|-------------|
| 计划追踪 | 有，但弱约束 | 必须强约束工具调用与执行范围 |
| 工具执行 | shell 在宿主机 | 全部在 sandbox/Docker 受控执行 |
| RAG | 有模块但未接入 | 必须接入执行链并支持增量索引 |
| 审批控制 | 有审批流程 | 审批后限制工具权限与步骤范围 |
| 状态持久化 | 无 | 计划/进度/变更需落库 |
| 变更机制 | 全量写文件 | 优先 patch/增量修改 |

---

## 5. 建议优先级（不改代码，仅作为路线参考）

**P0 必做**
1. 合并 `CodeAgent` 与 `PlanExecuteAgent`，统一入口与执行链。
2. 工具调用加入“步骤级白名单”，强制执行计划范围。
3. Shell 执行迁移到 Docker sandbox，统一安全策略。

**P1 增强**
4. RAG 接入执行链与工具系统，支持语义检索与增量索引。
5. 计划/执行状态持久化，支持重启恢复与审计。

**P2 优化**
6. 计划解析鲁棒性增强（结构化输出校验）。
7. 跳步检测由“关键词”升级为“步骤-工具-文件”一致性校验。

---

## 6. 补充说明

- 本审计基于当前实现与主流编程 Agent 的通用架构习惯做对比。
- 若需要，可继续输出：
  - 更完整的“生产级编排闭环设计”细节
  - 如何实现“审批后强约束执行”的机制蓝图
  - Cursor/Copilot/Claude 类产品在 Plan/Tool 控制上的常见模式

