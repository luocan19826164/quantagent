# Prompt优化说明 - 解决模糊建仓规则问题

## 问题描述

### 原问题
- 用户说："想在RSI超卖时买入"
- **DeepSeek**：认为这是建仓规则，直接赋值 `entry_rules: "RSI超卖时买入"`
- **OpenAI**：认为这个规则太模糊，不赋值

### 根本原因
缺少对"完整建仓规则"的定义和判断标准

## 优化方案

### 1. 增加负面示例（示例6）

```yaml
示例6 - 模糊的建仓规则（不满足完整建仓条件）:
  - 用户输入："想在RSI超卖时买入"
  - 处理方式：不填写entry_rules，继续追问具体条件
```

### 2. 完善entry_rules字段说明

**完整规则示例**：
- "RSI低于30且MACD金叉时买入" ✅
- "5日均线上穿10日均线，且成交量放大时买入" ✅
- "K线突破布林带上轨时买入" ✅

**模糊规则示例**：
- "RSI超卖时买入" ❌ 缺少具体阈值
- "技术指标确认后买入" ❌ 过于模糊
- "信号出现时买入" ❌ 缺少具体条件

**完整规则必须包含**：
1. 具体的指标名称（RSI、MACD、MA等）
2. 明确的数值或条件（"低于30"、"金叉"、"突破上轨"）
3. 完整的逻辑关系（多个条件之间的关系：且/或）

### 3. 新增原则说明

```
- 完整性判断：对于entry_rules，只有当用户提供了完整、可执行的建仓条件时才填写，模糊或不完整的描述应该继续追问而非直接赋值
- 指标要求：只有当entry_rules中包含具体可执行条件时，才填写indicators_required字段
```

### 4. 添加追问引导

在系统提示词中明确要求AI追问模糊描述：

```
当用户描述模糊的建仓规则时（如"超卖时买入"），不要直接赋值，而要追问具体条件：
* "RSI超卖" → 追问："RSI值低于多少算超卖？您希望具体是RSI<20还是RSI<30？"
* "技术指标确认" → 追问："是哪个指标？具体是什么样的信号？"
* "信号出现" → 追问："具体是什么信号？是金叉还是突破某个价位？"
```

## 优化效果

### 优化前
```
用户："想在RSI超卖时买入"
AI（DeepSeek）：✅ entry_rules = "RSI超卖时买入"  # 过于模糊
AI（OpenAI）：❌ 不填写，等待更多信息  # 正确但保守
```

### 优化后
```
用户："想在RSI超卖时买入"
AI：追问："RSI值低于多少算超卖？您希望具体是RSI<20还是RSI<30？等您确认后再设置建仓规则。"

用户："RSI低于30时买入"
AI：✅ entry_rules = "RSI低于30时买入", indicators_required = ["RSI"]
```

## 实现细节

### 修改的文件
- `backend/agent/prompts/prompt_config.yaml`

### 修改内容
1. **新增示例6**：展示如何处理模糊的建仓规则
2. **扩展entry_rules说明**：添加完整/模糊规则对比
3. **新增原则**：完整性判断和指标要求
4. **添加追问引导**：具体化的追问示例

### 生效方式
重启应用后生效：
```bash
# 重启应用
lsof -ti:8080 | xargs kill -9
python backend/app.py &
```

## 测试建议

### 测试用例1：模糊描述
```
用户："想在RSI超卖时买入"
预期：AI追问RSI的具体阈值，不填写entry_rules
```

### 测试用例2：完整描述
```
用户："当RSI低于30时买入"
预期：AI填写entry_rules = "RSI低于30时买入", indicators_required = ["RSI"]
```

### 测试用例3：多条件
```
用户："当RSI低于30且成交量放大时买入"
预期：AI填写完整规则，indicators_required = ["RSI"]
```

## 后续优化建议

1. **追加止盈止损规则**：同样需要明确具体数值
2. **指标组合验证**：检查指标使用的合理性
3. **规则复杂度限制**：避免过于复杂的条件组合

## 结论

通过明确"完整性判断标准"和"追问引导"，AI现在能够：
- 区分完整和模糊的建仓规则
- 对模糊描述主动追问
- 只填写完整、可执行的规则
- 保持体验友好
